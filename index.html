<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Momentum - Habit Tracker</title>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --bg-primary: #0a0f1e;
  --bg-secondary: #111827;
  --bg-card: #1a2332;
  --bg-hover: #243447;
  --text-primary: #f3f4f6;
  --text-secondary: #9ca3af;
  --border: #2d3748;
  --accent: #3b82f6;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --purple: #8b5cf6;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  overflow-x: hidden;
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
}

/* AUTH SCREEN */
.auth-screen {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.auth-card {
  background: var(--bg-card);
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  width: 100%;
  max-width: 420px;
  animation: slideUp 0.5s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.auth-header {
  text-align: center;
  margin-bottom: 30px;
}

.auth-header h1 {
  font-size: 32px;
  margin-bottom: 8px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.auth-header p {
  color: var(--text-secondary);
  font-size: 14px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

input[type="email"],
input[type="password"],
input[type="text"],
input[type="number"],
textarea,
select {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-secondary);
  border: 2px solid var(--border);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 14px;
  transition: all 0.3s ease;
}

input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: var(--accent);
  background: var(--bg-card);
}

textarea {
  resize: vertical;
  min-height: 80px;
}

.btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 2px solid var(--border);
}

.btn-secondary:hover {
  background: var(--bg-hover);
  border-color: var(--accent);
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-danger {
  background: var(--danger);
  color: white;
  padding: 8px 16px;
  width: auto;
}

.auth-toggle {
  text-align: center;
  margin-top: 20px;
  color: var(--text-secondary);
  font-size: 14px;
}

.auth-toggle a {
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
  cursor: pointer;
}

.auth-toggle a:hover {
  text-decoration: underline;
}

/* HEADER */
.app-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 0;
  border-bottom: 2px solid var(--border);
  margin-bottom: 30px;
}

.app-title {
  font-size: 28px;
  font-weight: 700;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

.user-email {
  color: var(--text-secondary);
  font-size: 14px;
}

/* STATS BANNER */
.stats-banner {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: var(--bg-card);
  padding: 24px;
  border-radius: 16px;
  border: 2px solid var(--border);
  transition: all 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-4px);
  border-color: var(--accent);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.stat-label {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.stat-value {
  font-size: 36px;
  font-weight: 700;
  color: var(--text-primary);
}

.stat-icon {
  font-size: 24px;
  margin-bottom: 8px;
}

/* PERFECT DAY BADGE */
.perfect-day {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  padding: 20px;
  border-radius: 16px;
  text-align: center;
  margin-bottom: 30px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

.perfect-day h3 {
  font-size: 24px;
  margin-bottom: 5px;
}

/* ADD HABIT FORM */
.add-habit-card {
  background: var(--bg-card);
  padding: 24px;
  border-radius: 16px;
  border: 2px solid var(--border);
  margin-bottom: 30px;
}

.add-habit-card h3 {
  margin-bottom: 20px;
  font-size: 18px;
}

.form-row {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}

.form-cols {
  display: grid;
  grid-template-columns: 1fr 1fr 100px;
  gap: 12px;
  margin-bottom: 12px;
}

.color-picker {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.color-option {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  cursor: pointer;
  border: 3px solid transparent;
  transition: all 0.2s ease;
}

.color-option:hover {
  transform: scale(1.1);
}

.color-option.active {
  border-color: white;
  box-shadow: 0 0 0 2px var(--bg-card), 0 0 0 4px var(--accent);
}

/* HABITS LIST */
.habits-section h2 {
  margin-bottom: 20px;
  font-size: 22px;
}

.habits-grid {
  display: grid;
  gap: 16px;
  margin-bottom: 30px;
}

.habit-card {
  background: var(--bg-card);
  padding: 20px;
  border-radius: 16px;
  border: 2px solid var(--border);
  display: flex;
  align-items: center;
  gap: 16px;
  transition: all 0.3s ease;
}

.habit-card:hover {
  border-color: var(--accent);
  background: var(--bg-hover);
}

.habit-checkbox {
  width: 28px;
  height: 28px;
  cursor: pointer;
  accent-color: var(--success);
}

.habit-color {
  width: 8px;
  height: 48px;
  border-radius: 4px;
}

.habit-content {
  flex: 1;
}

.habit-name {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 4px;
}

.habit-meta {
  display: flex;
  gap: 12px;
  align-items: center;
  font-size: 13px;
  color: var(--text-secondary);
}

.habit-category {
  background: var(--bg-secondary);
  padding: 4px 10px;
  border-radius: 6px;
}

.habit-weight {
  color: var(--warning);
}

.habit-actions {
  display: flex;
  gap: 8px;
}

.icon-btn {
  background: var(--bg-secondary);
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  font-size: 16px;
}

.icon-btn:hover {
  background: var(--bg-hover);
  transform: scale(1.1);
}

/* HEATMAP */
.heatmap-section {
  background: var(--bg-card);
  padding: 24px;
  border-radius: 16px;
  border: 2px solid var(--border);
  margin-bottom: 30px;
}

.heatmap-section h2 {
  margin-bottom: 20px;
  font-size: 22px;
}

.heatmap-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(32px, 1fr));
  gap: 6px;
}

.heatmap-day {
  aspect-ratio: 1;
  border-radius: 6px;
  background: var(--bg-secondary);
  transition: all 0.2s ease;
  cursor: pointer;
  position: relative;
}

.heatmap-day:hover {
  transform: scale(1.15);
}

.heatmap-day.empty {
  background: var(--bg-secondary);
}

.heatmap-day.low {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.heatmap-day.medium {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.heatmap-day.high {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.heatmap-day.perfect {
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
}

.heatmap-legend {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 20px;
  font-size: 13px;
  color: var(--text-secondary);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.legend-color {
  width: 16px;
  height: 16px;
  border-radius: 4px;
}

/* ANALYTICS */
.analytics-section {
  background: var(--bg-card);
  padding: 24px;
  border-radius: 16px;
  border: 2px solid var(--border);
  margin-bottom: 30px;
}

.analytics-section h2 {
  margin-bottom: 20px;
  font-size: 22px;
}

.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 20px;
}

.analytics-item {
  text-align: center;
}

.analytics-value {
  font-size: 32px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 5px;
}

.analytics-label {
  font-size: 13px;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* UTILITIES */
.hidden {
  display: none !important;
}

.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-secondary);
}

.spinner {
  border: 3px solid var(--border);
  border-top: 3px solid var(--accent);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.error-msg {
  background: var(--danger);
  color: white;
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 20px;
  font-size: 14px;
}

.success-msg {
  background: var(--success);
  color: white;
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 20px;
  font-size: 14px;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 20px;
  opacity: 0.5;
}

/* MODAL */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.modal {
  background: var(--bg-card);
  border-radius: 20px;
  padding: 30px;
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-header h3 {
  font-size: 20px;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
}

.modal-close:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .form-cols {
    grid-template-columns: 1fr;
  }

  .form-row {
    grid-template-columns: 1fr;
  }

  .stats-banner {
    grid-template-columns: 1fr;
  }

  .heatmap-grid {
    grid-template-columns: repeat(7, 1fr);
  }
}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="authScreen" class="auth-screen">
  <div class="auth-card">
    <div class="auth-header">
      <h1>‚ö° Momentum</h1>
      <p>Build better habits, one day at a time</p>
    </div>

    <div id="authError" class="error-msg hidden"></div>

    <div id="loginForm">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="your@email.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn btn-primary" onclick="handleLogin()">
        <span>Sign In</span>
      </button>
      <div class="auth-toggle">
        Don't have an account? <a onclick="toggleAuthMode()">Sign Up</a>
      </div>
    </div>

    <div id="signupForm" class="hidden">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="signupEmail" placeholder="your@email.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn btn-primary" onclick="handleSignup()">
        <span>Create Account</span>
      </button>
      <div class="auth-toggle">
        Already have an account? <a onclick="toggleAuthMode()">Sign In</a>
      </div>
    </div>
  </div>
</div>

<!-- LOADING SCREEN -->
<div id="loadingScreen" class="loading hidden">
  <div class="spinner"></div>
  <p>Loading your habits...</p>
</div>

<!-- MAIN APP -->
<div id="app" class="container hidden">

  <!-- HEADER -->
  <div class="app-header">
    <h1 class="app-title">‚ö° Momentum</h1>
    <div class="user-info">
      <span class="user-email" id="userEmail"></span>
      <button class="btn btn-danger" onclick="handleLogout()">Sign Out</button>
    </div>
  </div>

  <!-- PERFECT DAY BADGE -->
  <div id="perfectDayBadge" class="perfect-day hidden">
    <h3>üèÜ PERFECT DAY!</h3>
    <p>All habits completed! Keep up the amazing work!</p>
  </div>

  <!-- STATS BANNER -->
  <div class="stats-banner">
    <div class="stat-card">
      <div class="stat-icon">üìä</div>
      <div class="stat-label">Today's Score</div>
      <div class="stat-value" id="todayScore">0%</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üî•</div>
      <div class="stat-label">Current Streak</div>
      <div class="stat-value" id="streakCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚≠ê</div>
      <div class="stat-label">Weekly Avg</div>
      <div class="stat-value" id="weeklyAvg">0%</div>
    </div>
  </div>

  <!-- ADD HABIT -->
  <div class="add-habit-card">
    <h3>‚ûï Add New Habit</h3>
    <div class="form-row">
      <input type="text" id="habitName" placeholder="Habit name (e.g., Morning workout)">
      <input type="text" id="habitCategory" placeholder="Category">
    </div>
    <textarea id="habitDescription" placeholder="Description (optional)"></textarea>
    <div class="form-cols">
      <select id="habitWeight">
        <option value="1">‚≠ê Low Priority</option>
        <option value="2">‚≠ê‚≠ê Medium</option>
        <option value="3" selected>‚≠ê‚≠ê‚≠ê High</option>
        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Very High</option>
        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Critical</option>
      </select>
      <input type="number" id="habitGoal" placeholder="Goal/week" value="7" min="1" max="7">
      <button class="btn btn-success" onclick="addHabit()">Add</button>
    </div>
    <div class="color-picker">
      <div class="color-option active" data-color="#10b981" style="background: #10b981;"></div>
      <div class="color-option" data-color="#3b82f6" style="background: #3b82f6;"></div>
      <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;"></div>
      <div class="color-option" data-color="#f59e0b" style="background: #f59e0b;"></div>
      <div class="color-option" data-color="#ef4444" style="background: #ef4444;"></div>
      <div class="color-option" data-color="#ec4899" style="background: #ec4899;"></div>
    </div>
  </div>

  <!-- HABITS LIST -->
  <div class="habits-section">
    <h2>üìù Today's Habits</h2>
    <div id="habitsList" class="habits-grid"></div>
    <div id="emptyState" class="empty-state hidden">
      <div class="empty-state-icon">üéØ</div>
      <h3>No habits yet</h3>
      <p>Add your first habit above to get started!</p>
    </div>
  </div>

  <!-- HEATMAP -->
  <div class="heatmap-section">
    <h2>üìÖ Consistency Tracker (Last 56 Days)</h2>
    <div id="heatmap" class="heatmap-grid"></div>
    <div class="heatmap-legend">
      <div class="legend-item">
        <div class="legend-color" style="background: var(--bg-secondary);"></div>
        <span>No Data</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #ef4444;"></div>
        <span>0-50%</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #f59e0b;"></div>
        <span>50-80%</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #10b981;"></div>
        <span>80-99%</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #8b5cf6;"></div>
        <span>100%</span>
      </div>
    </div>
  </div>

  <!-- ANALYTICS -->
  <div class="analytics-section">
    <h2>üìà Performance Analytics</h2>
    <div class="analytics-grid">
      <div class="analytics-item">
        <div class="analytics-value" id="totalHabits">0</div>
        <div class="analytics-label">Total Habits</div>
      </div>
      <div class="analytics-item">
        <div class="analytics-value" id="completedToday">0</div>
        <div class="analytics-label">Completed Today</div>
      </div>
      <div class="analytics-item">
        <div class="analytics-value" id="monthlyAvg">0%</div>
        <div class="analytics-label">Monthly Avg</div>
      </div>
      <div class="analytics-item">
        <div class="analytics-value" id="bestStreak">0</div>
        <div class="analytics-label">Best Streak</div>
      </div>
    </div>
  </div>

</div>

<!-- EDIT HABIT MODAL -->
<div id="editModal" class="modal-overlay hidden" onclick="closeEditModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>‚úèÔ∏è Edit Habit</h3>
      <button class="modal-close" onclick="closeEditModal()">√ó</button>
    </div>
    <div class="form-group">
      <label>Habit Name</label>
      <input type="text" id="editName">
    </div>
    <div class="form-group">
      <label>Category</label>
      <input type="text" id="editCategory">
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea id="editDescription"></textarea>
    </div>
    <div class="form-group">
      <label>Priority</label>
      <select id="editWeight">
        <option value="1">‚≠ê Low Priority</option>
        <option value="2">‚≠ê‚≠ê Medium</option>
        <option value="3">‚≠ê‚≠ê‚≠ê High</option>
        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Very High</option>
        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Critical</option>
      </select>
    </div>
    <div class="form-group">
      <label>Weekly Goal</label>
      <input type="number" id="editGoal" min="1" max="7">
    </div>
    <button class="btn btn-primary" onclick="saveEditHabit()">Save Changes</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ============================================================================
// SUPABASE SETUP
// ============================================================================
const SUPABASE_URL = 'https://sktsgqnuopgqjhczdtfp.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrdHNncW51b3BncWpoY3pkdGZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MDUzMjEsImV4cCI6MjA4MTM4MTMyMX0.KXMlpv6qYL-uM8CUO0TvjdLTAviqgaxFIkYyyV8FVWI';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ============================================================================
// STATE
// ============================================================================
let currentUser = null;
let habits = [];
let dailyLogs = [];
let selectedColor = '#10b981';
let editingHabitId = null;

// ============================================================================
// AUTH
// ============================================================================
async function initAuth() {
  const { data: { session } } = await supabase.auth.getSession();

  if (session) {
    currentUser = session.user;
    showApp();
    await loadData();
  } else {
    showAuthScreen();
  }

  supabase.auth.onAuthStateChange((_event, session) => {
    (async () => {
      if (session) {
        currentUser = session.user;
        showApp();
        await loadData();
      } else {
        currentUser = null;
        showAuthScreen();
      }
    })();
  });
}

function toggleAuthMode() {
  loginForm.classList.toggle('hidden');
  signupForm.classList.toggle('hidden');
  authError.classList.add('hidden');
}

async function handleLogin() {
  const email = loginEmail.value.trim();
  const password = loginPassword.value;

  if (!email || !password) {
    showAuthError('Please fill in all fields');
    return;
  }

  const { error } = await supabase.auth.signInWithPassword({ email, password });

  if (error) {
    showAuthError(error.message);
  }
}

async function handleSignup() {
  const email = signupEmail.value.trim();
  const password = signupPassword.value;

  if (!email || !password) {
    showAuthError('Please fill in all fields');
    return;
  }

  if (password.length < 6) {
    showAuthError('Password must be at least 6 characters');
    return;
  }

  const { error } = await supabase.auth.signUp({ email, password });

  if (error) {
    showAuthError(error.message);
  } else {
    showAuthError('Account created! Please sign in.');
    toggleAuthMode();
  }
}

async function handleLogout() {
  await supabase.auth.signOut();
}

function showAuthError(message) {
  authError.textContent = message;
  authError.classList.remove('hidden');
}

function showAuthScreen() {
  authScreen.classList.remove('hidden');
  loadingScreen.classList.add('hidden');
  app.classList.add('hidden');
}

function showApp() {
  authScreen.classList.add('hidden');
  loadingScreen.classList.add('hidden');
  app.classList.remove('hidden');
  userEmail.textContent = currentUser.email;
}

function showLoading() {
  authScreen.classList.add('hidden');
  loadingScreen.classList.remove('hidden');
  app.classList.add('hidden');
}

// ============================================================================
// DATA LOADING
// ============================================================================
async function loadData() {
  showLoading();

  try {
    // Load habits
    const { data: habitsData, error: habitsError } = await supabase
      .from('habits')
      .select('*')
      .eq('is_archived', false)
      .order('created_at', { ascending: true });

    if (habitsError) throw habitsError;
    habits = habitsData || [];

    // Load last 60 days of logs
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 60);

    const { data: logsData, error: logsError } = await supabase
      .from('daily_logs')
      .select('*')
      .gte('log_date', startDate.toISOString().split('T')[0]);

    if (logsError) throw logsError;
    dailyLogs = logsData || [];

    showApp();
    render();
  } catch (error) {
    console.error('Error loading data:', error);
    alert('Error loading data. Please refresh the page.');
  }
}

// ============================================================================
// HABITS
// ============================================================================
async function addHabit() {
  const name = habitName.value.trim();
  const category = habitCategory.value.trim() || 'General';
  const description = habitDescription.value.trim();
  const weight = parseInt(habitWeight.value);
  const goalFrequency = parseInt(habitGoal.value);

  if (!name) {
    alert('Please enter a habit name');
    return;
  }

  const { data, error } = await supabase
    .from('habits')
    .insert([{
      user_id: currentUser.id,
      name,
      category,
      description,
      weight,
      color: selectedColor,
      goal_frequency: goalFrequency
    }])
    .select();

  if (error) {
    console.error('Error adding habit:', error);
    alert('Error adding habit');
    return;
  }

  habits.push(data[0]);

  // Clear form
  habitName.value = '';
  habitCategory.value = '';
  habitDescription.value = '';
  habitWeight.value = '3';
  habitGoal.value = '7';

  render();
}

async function toggleHabit(habitId, completed) {
  const today = new Date().toISOString().split('T')[0];

  const existingLog = dailyLogs.find(log =>
    log.habit_id === habitId && log.log_date === today
  );

  if (existingLog) {
    const { error } = await supabase
      .from('daily_logs')
      .update({ completed })
      .eq('id', existingLog.id);

    if (error) {
      console.error('Error updating log:', error);
      return;
    }

    existingLog.completed = completed;
  } else {
    const { data, error } = await supabase
      .from('daily_logs')
      .insert([{
        user_id: currentUser.id,
        habit_id: habitId,
        log_date: today,
        completed
      }])
      .select();

    if (error) {
      console.error('Error creating log:', error);
      return;
    }

    dailyLogs.push(data[0]);
  }

  renderStats();
  renderHeatmap();
  renderAnalytics();
}

function openEditModal(habitId) {
  const habit = habits.find(h => h.id === habitId);
  if (!habit) return;

  editingHabitId = habitId;
  editName.value = habit.name;
  editCategory.value = habit.category;
  editDescription.value = habit.description || '';
  editWeight.value = habit.weight;
  editGoal.value = habit.goal_frequency;

  editModal.classList.remove('hidden');
}

function closeEditModal(event) {
  if (event && event.target !== editModal) return;
  editModal.classList.add('hidden');
  editingHabitId = null;
}

async function saveEditHabit() {
  if (!editingHabitId) return;

  const name = editName.value.trim();
  const category = editCategory.value.trim();
  const description = editDescription.value.trim();
  const weight = parseInt(editWeight.value);
  const goalFrequency = parseInt(editGoal.value);

  if (!name) {
    alert('Please enter a habit name');
    return;
  }

  const { error } = await supabase
    .from('habits')
    .update({
      name,
      category,
      description,
      weight,
      goal_frequency: goalFrequency
    })
    .eq('id', editingHabitId);

  if (error) {
    console.error('Error updating habit:', error);
    alert('Error updating habit');
    return;
  }

  const habit = habits.find(h => h.id === editingHabitId);
  if (habit) {
    habit.name = name;
    habit.category = category;
    habit.description = description;
    habit.weight = weight;
    habit.goal_frequency = goalFrequency;
  }

  closeEditModal();
  render();
}

async function deleteHabit(habitId) {
  if (!confirm('Are you sure you want to delete this habit?')) return;

  const { error } = await supabase
    .from('habits')
    .update({ is_archived: true })
    .eq('id', habitId);

  if (error) {
    console.error('Error deleting habit:', error);
    alert('Error deleting habit');
    return;
  }

  habits = habits.filter(h => h.id !== habitId);
  render();
}

// ============================================================================
// RENDERING
// ============================================================================
function render() {
  renderHabits();
  renderStats();
  renderHeatmap();
  renderAnalytics();
}

function renderHabits() {
  if (habits.length === 0) {
    habitsList.innerHTML = '';
    emptyState.classList.remove('hidden');
    return;
  }

  emptyState.classList.add('hidden');

  const today = new Date().toISOString().split('T')[0];

  habitsList.innerHTML = habits.map(habit => {
    const log = dailyLogs.find(l => l.habit_id === habit.id && l.log_date === today);
    const completed = log?.completed || false;
    const stars = '‚≠ê'.repeat(habit.weight);

    return `
      <div class="habit-card">
        <input
          type="checkbox"
          class="habit-checkbox"
          ${completed ? 'checked' : ''}
          onchange="toggleHabit('${habit.id}', this.checked)"
        >
        <div class="habit-color" style="background: ${habit.color};"></div>
        <div class="habit-content">
          <div class="habit-name">${habit.name}</div>
          <div class="habit-meta">
            <span class="habit-category">${habit.category}</span>
            <span class="habit-weight">${stars}</span>
            <span>üéØ ${habit.goal_frequency}/week</span>
          </div>
        </div>
        <div class="habit-actions">
          <button class="icon-btn" onclick="openEditModal('${habit.id}')" title="Edit">‚úèÔ∏è</button>
          <button class="icon-btn" onclick="deleteHabit('${habit.id}')" title="Delete">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }).join('');
}

function renderStats() {
  const today = new Date().toISOString().split('T')[0];
  const todayLogs = dailyLogs.filter(l => l.log_date === today && l.completed);

  let totalWeight = 0;
  let completedWeight = 0;

  habits.forEach(habit => {
    totalWeight += habit.weight;
    if (todayLogs.some(l => l.habit_id === habit.id)) {
      completedWeight += habit.weight;
    }
  });

  const percentage = totalWeight > 0 ? Math.round((completedWeight / totalWeight) * 100) : 0;
  todayScore.textContent = percentage + '%';

  // Perfect day badge
  if (percentage === 100 && habits.length > 0) {
    perfectDayBadge.classList.remove('hidden');
  } else {
    perfectDayBadge.classList.add('hidden');
  }

  // Streak
  const streak = calculateStreak();
  streakCount.textContent = streak;

  // Weekly average
  const weeklyAverage = calculateAverage(7);
  weeklyAvg.textContent = weeklyAverage + '%';
}

function calculateStreak() {
  let streak = 0;
  const date = new Date();

  while (true) {
    const dateStr = date.toISOString().split('T')[0];
    const dayLogs = dailyLogs.filter(l => l.log_date === dateStr && l.completed);

    if (dayLogs.length === 0) break;

    const allCompleted = habits.every(habit =>
      dayLogs.some(l => l.habit_id === habit.id)
    );

    if (!allCompleted) break;

    streak++;
    date.setDate(date.getDate() - 1);

    if (streak > 365) break; // Safety limit
  }

  return streak;
}

function calculateAverage(days) {
  let totalPercentage = 0;
  let daysWithData = 0;

  for (let i = 0; i < days; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];

    const dayLogs = dailyLogs.filter(l => l.log_date === dateStr && l.completed);

    if (habits.length === 0) continue;

    let dayWeight = 0;
    let completedWeight = 0;

    habits.forEach(habit => {
      dayWeight += habit.weight;
      if (dayLogs.some(l => l.habit_id === habit.id)) {
        completedWeight += habit.weight;
      }
    });

    if (dayWeight > 0) {
      totalPercentage += (completedWeight / dayWeight) * 100;
      daysWithData++;
    }
  }

  return daysWithData > 0 ? Math.round(totalPercentage / daysWithData) : 0;
}

function renderHeatmap() {
  const days = 56;
  let html = '';

  for (let i = days - 1; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];

    const dayLogs = dailyLogs.filter(l => l.log_date === dateStr && l.completed);

    let cssClass = 'empty';

    if (habits.length > 0 && dayLogs.length > 0) {
      let dayWeight = 0;
      let completedWeight = 0;

      habits.forEach(habit => {
        dayWeight += habit.weight;
        if (dayLogs.some(l => l.habit_id === habit.id)) {
          completedWeight += habit.weight;
        }
      });

      const percentage = (completedWeight / dayWeight) * 100;

      if (percentage === 100) {
        cssClass = 'perfect';
      } else if (percentage >= 80) {
        cssClass = 'high';
      } else if (percentage >= 50) {
        cssClass = 'medium';
      } else {
        cssClass = 'low';
      }
    }

    html += `<div class="heatmap-day ${cssClass}" title="${dateStr}"></div>`;
  }

  heatmap.innerHTML = html;
}

function renderAnalytics() {
  totalHabits.textContent = habits.length;

  const today = new Date().toISOString().split('T')[0];
  const todayCompleted = dailyLogs.filter(l => l.log_date === today && l.completed).length;
  completedToday.textContent = todayCompleted;

  const monthlyAverage = calculateAverage(30);
  monthlyAvg.textContent = monthlyAverage + '%';

  // Calculate best streak
  let maxStreak = 0;
  let currentStreakCalc = 0;

  for (let i = 0; i < 365; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];

    const dayLogs = dailyLogs.filter(l => l.log_date === dateStr && l.completed);

    if (habits.length > 0) {
      const allCompleted = habits.every(habit =>
        dayLogs.some(l => l.habit_id === habit.id)
      );

      if (allCompleted) {
        currentStreakCalc++;
        maxStreak = Math.max(maxStreak, currentStreakCalc);
      } else {
        currentStreakCalc = 0;
      }
    }
  }

  bestStreak.textContent = maxStreak;
}

// ============================================================================
// COLOR PICKER
// ============================================================================
document.querySelectorAll('.color-option').forEach(option => {
  option.addEventListener('click', () => {
    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
    option.classList.add('active');
    selectedColor = option.dataset.color;
  });
});

// ============================================================================
// INIT
// ============================================================================
initAuth();
</script>

</body>
</html>